@model int?
@{
    ViewBag.Title = "ProcesarIncidente";
}

<div class="card js-sweetalert">
    <div class="header">
        <h2 class="tit">
            REPORTE DE INCIDENTES QA
        </h2>
        <h2 class="tit">
            NOTIFICACIÓN # @ViewBag.Cons<small>Procesamiento de notificación ™</small>
        </h2>

    </div>
    <div class="body js-sweetalert clearfix">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            @using (Html.BeginForm("ProcesarIncidente", "ReportarIncidentes", FormMethod.Post, new { @id = "wizard_validation" }))
            {
                @Html.Hidden("Id", Model)
                <h3>Notificación</h3>
                <section class="clearfix"></section>

                <h3>Análisis de causas & 4M</h3>
                <section></section>

                <h3>Plan de acción</h3>
                <section></section>

                <h3>Verificación y finalización</h3>
                <section></section>
            }
        </div>
    </div>
</div>
<!-- JQuery Steps Plugin Js -->
<script src="~/Scripts/Adminbsb/plugins/jquery-steps/jquery.steps.min.js"></script>
<script>
    $(function () {
        //Advanced form with validation
        var form = $('#wizard_validation').show();
        form.steps({
            headerTag: 'h3',
            bodyTag: 'section',
            transitionEffect: 'slideLeft',
            labels: {
                next: "Siguiente",
                cancel: "Cancelar",
                current: "Paso actual:",
                pagination: "Paginación",
                finish: "Finalizar",
                previous: "Anterior",
                loading: "Cargando..."
            },
            onInit: function (event, currentIndex) {
                $.AdminBSB.input.activate();

                //Set tab width
                var $tab = $(event.currentTarget).find('ul[role="tablist"] li');
                var tabCount = $tab.length;
                $tab.css('width', (100 / tabCount) + '%');

                //set button waves effect
                setButtonWavesEffect(event);
            },
            onStepChanging: function (event, currentIndex, newIndex) {

                if (currentIndex > newIndex) {
                    return true;
                }
                                

                if (currentIndex < newIndex) {
                    form.find('.body:eq(' + newIndex + ') label.error').remove();
                    form.find('.body:eq(' + newIndex + ') .error').removeClass('error');
                }

                form.validate().settings.ignore = ':disabled,:hidden';

                return form.valid();
                //return true;
            },
            onStepChanged: function (event, currentIndex, priorIndex) {

                setButtonWavesEffect(event);                
            },
            onFinishing: function (event, currentIndex) {                               

                form.validate().settings.ignore = ':disabled,.ignore';
                return form.valid();
                //return true;
            },
            onFinished: function (event, currentIndex) {
                var form = $('#wizard_validation')[0];
                var dataString = new FormData(form);

                

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("ProcesarIncidente", "ReportarIncidentes")',
                    data: dataString,
                    beforeSend: function () {
                        $('.page-loader-wrapper').fadeIn();
                    },
                    success: function (response) {

                        $('#downloadModal').modal('toggle');

                        //MENSAJE DE CONFIRMACIÓN O ERROR
                        if (response.code == 1) {
                            $('#modalMsg').text("Formato creado correctamente!");                            
                            //window.location = '/ReportarIncidentes/DownloadEwoFile';
                        }
                        else if (response.code == -1) {
                            $('#modalMsg').text("Error al crear formato!" + response.message);
                        }
                        else {
                            $('#modalMsg').text("No se pudo crear formato, intente nuevamente!");
                        }
                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });

                $('.page-loader-wrapper').hide();
            }
        });

        form.validate({
            highlight: function (input) {
                $(input).parents('.form-line').addClass('error');
            },
            unhighlight: function (element, errorClass, validClass) {
                if ($(element).hasClass("error")) {
                    $(element).parents('.form-line').removeClass('error');
                    $(element).removeClass(errorClass).addClass(validClass).tooltipster('close');
                }
            },
            rules: {
                //'confirm': { equalTo: '#password' },
                //'IdPlanta': { valueNotEquals: "0" },
                //'IdTipoLinea': { valueNotEquals: "0" },
                //'IdLinea': { valueNotEquals: "0" },
                //'IdMaquina': { valueNotEquals: "0" },
                //'IdTipoAveria': { valueNotEquals: "0" },
                //'dz_text': { valueNotEquals: "" }
            },
            success: function (label, element) {
                label.parent().removeClass('error');
                label.remove();
            },
            messages: {
                //'IdPlanta': { valueNotEquals: "Debe seleccionar planta..." }
            }
        });

        function setButtonWavesEffect(event) {
            $(event.currentTarget).find('[role="menu"] li a').removeClass('waves-effect');
            $(event.currentTarget).find('[role="menu"] li:not(.disabled) a').addClass('waves-effect');
        }
    });
</script>